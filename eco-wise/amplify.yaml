version: 1
applications:
  - frontend:
      appRoot: eco-wise  # Set this to the directory of your frontend code
      phases:
        preBuild:
          commands:
            - npm ci --cache .npm --prefer-offline
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: eco-wise/build
        files:
          - "**/*"
      cache:
        paths:
          - eco-wise/.npm/**/*
    backend:
      appRoot: lambdas  # Optional, if needed for a multi-root monorepo
      phases:
        install:
          runtime-versions:
            nodejs: 22.x
          commands:
            - echo "Installing dependencies for Lambda functions..."
            - cd lambdas
            - npm ci  # Ensure this command runs in the `lambdas` directory for any global dependencies
        build:
          commands:
            - echo "Building and deploying Lambda functions..."
            - |
              export CODEBUILD=true
              cd lambdas
              for function in */ ; do
                echo "Deploying ${function%/}..."
                cd ${function%/}

                if [ -f "index.js" ]; then
                  # Use existing role ARN for Lambda function deployment
                  echo "Compiling code to a single file for ${function%/}..."
                  npx ncc build index.js

                  echo "Zipping ${function%/} handler code..."
                  zip -j deploy.zip ./dist/*

                  # Deploy or update Lambda function
                  aws lambda get-function --function-name=${function%/} > /dev/null 2>&1
                  status=$?
                  if [ $status -eq 0 ]; then
                    echo "Lambda '${function%/}' exists. Updating..."
                    aws lambda update-function-code --function-name=${function%/} --zip-file=fileb://deploy.zip
                    echo "Updated ${function%/}."
                  else
                    echo "Lambda '${function%/}' does not exist. Creating..."
                    aws lambda create-function --function-name=${function%/} \
                      --role arn:aws:iam::127609216116:role/LabRole \
                      --runtime nodejs22.x --handler index.handler --zip-file fileb://deploy.zip
                    echo "Created ${function%/}."
                  fi
                fi

                cd ..
              done
      cache:
        paths:
          - lambdas/**/*
